<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ÂùÇÂá∫Â∏Ç Interactive Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>
<style>
html,body{height:100%;margin:0;font-family:Arial,sans-serif}
#view{position:absolute;width:100%;height:100%}
.tool-panel{position:fixed;right:10px;top:10px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.tool-btn{width:44px;height:44px;background:rgba(255,255,255,0.92);border:1px solid rgba(0,0,0,0.1);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 1px 4px rgba(0,0,0,0.15);transition:all 0.2s}
.tool-btn:hover{background:rgba(255,255,255,1);box-shadow:0 2px 8px rgba(0,0,0,0.25)}
.tool-btn.active{background:rgba(255,100,100,0.9);color:#fff}
.panel-content{position:fixed;right:64px;top:10px;background:rgba(255,255,255,0.95);padding:12px;border-radius:6px;box-shadow:0 2px 10px rgba(0,0,0,0.2);max-width:280px;z-index:9998;display:none}
.panel-content.show{display:block}
.panel-title{margin:0 0 10px;font-size:14px;font-weight:bold;color:#333;border-bottom:1px solid #ddd;padding-bottom:6px}
.panel-group{margin-bottom:10px}
.panel-group label{display:block;font-size:12px;margin-bottom:4px;color:#555}
.small-btn{display:inline-block;padding:5px 10px;margin:2px;background:#4CAF50;color:#fff;border:none;border-radius:3px;cursor:pointer;font-size:11px}
.small-btn:hover{background:#45a049}
.small-btn.active{background:#ff6b6b}
.file-label{display:inline-block;padding:5px 8px;background:#2196F3;color:#fff;border-radius:3px;cursor:pointer;font-size:10px;margin-top:3px}
.file-label:hover{background:#0b7dda}
input[type=file]{display:none}
.text-input{width:100%;padding:5px;border:1px solid #ccc;border-radius:3px;font-size:11px;box-sizing:border-box}
.info-panel{position:fixed;bottom:10px;left:10px;background:rgba(255,255,255,0.92);padding:8px 12px;border-radius:4px;font-size:11px;z-index:9999;box-shadow:0 1px 4px rgba(0,0,0,0.15)}
.coords{font-family:monospace;font-size:10px;color:#666}
.toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:rgba(40,40,40,0.9);color:#fff;padding:10px 20px;border-radius:4px;font-size:12px;z-index:10000;opacity:0;transition:opacity 0.3s;pointer-events:none}
.toast.show{opacity:1}
.measure-label{background:#ff6b6b;color:#fff;padding:3px 6px;border-radius:3px;font-size:10px;font-weight:bold}
.csv-icon{width:20px;height:20px;background:#2196F3;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.3)}
.city-label{background:#4CAF50;color:#fff;padding:6px 10px;border-radius:5px;font-weight:bold;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
@media (max-width:768px){
  .panel-content{right:10px;top:64px;max-width:calc(100vw - 20px)}
  .tool-panel{flex-direction:row;flex-wrap:wrap;width:auto;max-width:calc(100vw - 20px)}
}
</style>
</head>
<body>
<div id="view"></div>
<div class="tool-panel">
<button class="tool-btn" onclick="AppCtrl.togglePanel('base')" title="Base Maps">üó∫Ô∏è</button>
<button class="tool-btn" id="rulerBtn" onclick="AppCtrl.toggleRuler()" title="Measure Distance">üìè</button>
<button class="tool-btn" onclick="AppCtrl.togglePanel('data')" title="Import Data">üìÅ</button>
<button class="tool-btn" onclick="AppCtrl.togglePanel('vector')" title="Vector Tiles">üî≤</button>
</div>
<div class="panel-content" id="basePanel">
<div class="panel-title">Background Maps</div>
<div class="panel-group">
<button class="small-btn" onclick="AppCtrl.switchTiles('street')">Street</button>
<button class="small-btn" onclick="AppCtrl.switchTiles('imagery')">Satellite</button>
<button class="small-btn" onclick="AppCtrl.switchTiles('topo')">Topography</button>
</div>
</div>
<div class="panel-content" id="dataPanel">
<div class="panel-title">Import Data</div>
<div class="panel-group">
<label>GeoJSON File:</label>
<label class="file-label">Choose File<input type="file" accept=".geojson,.json" onchange="AppCtrl.importGeoJson(event)"></label>
</div>
<div class="panel-group">
<label>CSV Data:</label>
<label class="file-label">Choose File<input type="file" accept=".csv" onchange="AppCtrl.importCsv(event)"></label>
</div>
<div class="panel-group">
<button class="small-btn" onclick="AppCtrl.resetRuler()">Clear Measurements</button>
</div>
</div>
<div class="panel-content" id="vectorPanel">
<div class="panel-title">Vector Tiles (PBF)</div>
<div class="panel-group">
<label>Tile URL:</label>
<input type="text" class="text-input" id="pbfUrl" placeholder="https://example.com/{z}/{x}/{y}.pbf">
<button class="small-btn" onclick="AppCtrl.addPbfLayer()" style="width:100%;margin-top:5px">Load MVT</button>
</div>
</div>
<div class="info-panel">
<div>üìç <span id="location">Sakaide City, Kagawa Prefecture</span></div>
<div class="coords" id="coords">Lat: 34.3148 | Lon: 133.8547 | Scale: 1:250k</div>
</div>
<div class="toast" id="toast"></div>
<script>
const AppCtrl={
  theMap:null,
  SAKAIDE_LAT:34.3148,
  SAKAIDE_LNG:133.8547,
  currentBase:null,
  rulerMode:false,
  rulerPts:[],
  rulerElems:[],
  geoLayers:[],
  csvPins:[],
  pbfRef:null,
  currentPanel:null,
  
  escapeHtml(txt){
    const div=document.createElement('div');
    div.textContent=txt;
    return div.innerHTML;
  },
  
  init(){
    this.theMap=L.map('view').setView([this.SAKAIDE_LAT,this.SAKAIDE_LNG],13);
    this.tiles={
      street:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OSM'}),
      imagery:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Esri'}),
      topo:L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{attribution:'OpenTopoMap'})
    };
    this.currentBase='street';
    this.tiles.street.addTo(this.theMap);
    
    L.control.scale({position:'bottomright',imperial:false}).addTo(this.theMap);
    
    const cityPin=L.divIcon({className:'',html:'<div class="city-label">ÂùÇÂá∫Â∏Ç</div>'});
    L.marker([this.SAKAIDE_LAT,this.SAKAIDE_LNG],{icon:cityPin}).addTo(this.theMap).bindPopup('<strong>ÂùÇÂá∫Â∏Ç</strong><br>Sakaide, Kagawa');
    
    this.theMap.on('mousemove',e=>{
      this.updateCoords(e.latlng.lat,e.latlng.lng);
    });
    
    this.theMap.on('zoomend moveend',()=>{
      const center=this.theMap.getCenter();
      this.updateCoords(center.lat,center.lng);
    });
    
    this.theMap.on('click',e=>{
      if(!this.rulerMode)return;
      this.rulerPts.push(e.latlng);
      const dot=L.circleMarker(e.latlng,{radius:5,fillColor:'#ff6b6b',color:'#fff',weight:2,fillOpacity:1}).addTo(this.theMap);
      this.rulerElems.push(dot);
      
      if(this.rulerPts.length>=2){
        const p1=this.rulerPts[this.rulerPts.length-2];
        const p2=this.rulerPts[this.rulerPts.length-1];
        const pt1=turf.point([p1.lng,p1.lat]);
        const pt2=turf.point([p2.lng,p2.lat]);
        const km=turf.distance(pt1,pt2,{units:'kilometers'});
        const m=km*1000;
        
        const connector=L.polyline([p1,p2],{color:'#ff6b6b',weight:2}).addTo(this.theMap);
        this.rulerElems.push(connector);
        
        const midLat=(p1.lat+p2.lat)/2;
        const midLng=(p1.lng+p2.lng)/2;
        const tag=L.marker([midLat,midLng],{
          icon:L.divIcon({className:'',html:`<div class="measure-label">${m<1000?m.toFixed(0)+'m':km.toFixed(2)+'km'}</div>`})
        }).addTo(this.theMap);
        this.rulerElems.push(tag);
        
        this.notify(`Distance: ${m<1000?m.toFixed(0)+'m':km.toFixed(2)+'km'}`);
      }
    });
  },
  
  updateCoords(lat,lng){
    const zoom=this.theMap.getZoom();
    const scales=[500000000,250000000,150000000,70000000,35000000,15000000,10000000,4000000,2000000,1000000,500000,250000,150000,70000,35000,15000,8000,4000,2000,1000,500,250];
    const scale=scales[zoom]||1000;
    const scaleStr=scale>=1000?(scale/1000)+'k':scale;
    document.getElementById('coords').textContent=`Lat: ${lat.toFixed(4)} | Lon: ${lng.toFixed(4)} | Scale: 1:${scaleStr}`;
  },
  
  togglePanel(id){
    const panels=['base','data','vector'];
    const panelId=id+'Panel';
    panels.forEach(p=>{
      const el=document.getElementById(p+'Panel');
      if(p===id){
        if(el.classList.contains('show')){
          el.classList.remove('show');
          this.currentPanel=null;
        }else{
          el.classList.add('show');
          this.currentPanel=id;
        }
      }else{
        el.classList.remove('show');
      }
    });
  },
  
  switchTiles(key){
    if(this.currentBase)this.theMap.removeLayer(this.tiles[this.currentBase]);
    this.tiles[key].addTo(this.theMap);
    this.currentBase=key;
    this.notify('Base layer: '+key);
  },
  
  toggleRuler(){
    this.rulerMode=!this.rulerMode;
    const btn=document.getElementById('rulerBtn');
    if(this.rulerMode){
      btn.classList.add('active');
      this.theMap.getContainer().style.cursor='crosshair';
      this.notify('Click map to measure distance');
    }else{
      btn.classList.remove('active');
      this.theMap.getContainer().style.cursor='';
      this.notify('Ruler disabled');
    }
  },
  
  resetRuler(){
    this.rulerPts=[];
    this.rulerElems.forEach(el=>this.theMap.removeLayer(el));
    this.rulerElems=[];
    this.notify('Measurements cleared');
  },
  
  importGeoJson(evt){
    const f=evt.target.files[0];
    if(!f)return;
    const r=new FileReader();
    r.onload=e=>{
      try{
        const data=JSON.parse(e.target.result);
        const lyr=L.geoJSON(data,{
          style:{color:'#9C27B0',weight:2,fillOpacity:0.3},
          pointToLayer:(feat,ll)=>L.circleMarker(ll,{radius:7,fillColor:'#9C27B0',color:'#fff',weight:1,fillOpacity:0.8}),
          onEachFeature:(feat,layer)=>{
            if(feat.properties){
              const info=Object.entries(feat.properties).map(([k,v])=>`<b>${this.escapeHtml(String(k))}:</b> ${this.escapeHtml(String(v))}`).join('<br>');
              layer.bindPopup(info);
            }
          }
        }).addTo(this.theMap);
        this.geoLayers.push(lyr);
        const bb=lyr.getBounds();
        if(bb.isValid())this.theMap.fitBounds(bb,{padding:[40,40]});
        this.notify('GeoJSON loaded: '+f.name);
      }catch(err){
        this.notify('Error: '+err.message);
      }
    };
    r.readAsText(f);
    evt.target.value='';
  },
  
  importCsv(evt){
    const f=evt.target.files[0];
    if(!f)return;
    const r=new FileReader();
    r.onload=e=>{
      try{
        const lines=e.target.result.split('\n').filter(l=>l.trim());
        if(lines.length<2){this.notify('CSV empty');return;}
        
        const hdr=lines[0].split(',').map(h=>h.trim().toLowerCase());
        const latCol=hdr.findIndex(h=>h.includes('lat')||h==='y');
        const lngCol=hdr.findIndex(h=>h.includes('lon')||h.includes('lng')||h==='x');
        
        if(latCol<0||lngCol<0){this.notify('No lat/lon columns');return;}
        
        let cnt=0;
        for(let i=1;i<lines.length;i++){
          const vals=lines[i].split(',');
          const lat=parseFloat(vals[latCol]);
          const lng=parseFloat(vals[lngCol]);
          if(!isNaN(lat)&&!isNaN(lng)){
            const pin=L.marker([lat,lng],{
              icon:L.divIcon({className:'',html:'<div class="csv-icon"></div>'})
            }).addTo(this.theMap);
            const details=hdr.map((h,idx)=>`<b>${this.escapeHtml(h)}:</b> ${this.escapeHtml(vals[idx]||'?')}`).join('<br>');
            pin.bindPopup(details);
            this.csvPins.push(pin);
            cnt++;
          }
        }
        this.notify(`CSV: ${cnt} points from ${f.name}`);
      }catch(err){
        this.notify('CSV error: '+err.message);
      }
    };
    r.readAsText(f);
    evt.target.value='';
  },
  
  addPbfLayer(){
    const url=document.getElementById('pbfUrl').value.trim();
    if(!url){this.notify('Enter PBF URL');return;}
    
    if(this.pbfRef)this.theMap.removeLayer(this.pbfRef);
    
    try{
      this.pbfRef=L.vectorGrid.protobuf(url,{
        rendererFactory:L.canvas.tile,
        vectorTileLayerStyles:{},
        interactive:true
      }).addTo(this.theMap);
      
      this.pbfRef.on('click',e=>{
        if(e.layer&&e.layer.properties){
          const props=e.layer.properties;
          const txt=Object.entries(props).slice(0,8).map(([k,v])=>`<b>${this.escapeHtml(String(k))}:</b> ${this.escapeHtml(String(v))}`).join('<br>');
          L.popup().setLatLng(e.latlng).setContent(txt).openOn(this.theMap);
        }
      });
      
      this.notify('Vector tiles loaded');
    }catch(err){
      this.notify('PBF error: '+err.message);
    }
  },
  
  notify(txt){
    const el=document.getElementById('toast');
    el.textContent=txt;
    el.classList.add('show');
    setTimeout(()=>{el.classList.remove('show');},3000);
  }
};

AppCtrl.init();
</script>
</body>
</html>
